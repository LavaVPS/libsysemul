default-build: &default-build
  environment:
    CIRCLE_REPOSITORY_URL: https://github.com/LavaVPS/libsysemul.git
  steps:
    - run:
        name: Install git and make
        command: apt-get update -qq && apt-get install -y git make
    - run:
        name: Checkout
        command: |
          git clone "$CIRCLE_REPOSITORY_URL" .
          git reset --hard "$CIRCLE_SHA1"
    - run:
        name: Build before
        command: set && make build_before
    - run:
        name: Build package
        command: make pkg-build
    - run:
        name: Running tests
        command: make pkg-test

version: 2
jobs:
  build-jessie:
    <<: *default-build
    docker:
      - image: debian:jessie
  build-stretch:
    <<: *default-build
    docker:
      - image: debian:stretch
  build-ubuntu16.04:
    <<: *default-build
    docker:
      - image: ubuntu:16.04

workflows:
  version: 2
  build:
    jobs:
      - build-stretch
      - build-jessie
      - build-ubuntu16.04
